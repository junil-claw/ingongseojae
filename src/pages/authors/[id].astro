---
import Base from '../../layouts/Base.astro';
import { supabaseAdmin, GENRES } from '../../lib/supabase';

const { id } = Astro.params;

let author: any = null;
let works: any[] = [];
let error: string | null = null;

if (!id) {
  error = 'ì‘ê°€ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.';
} else if (supabaseAdmin) {
  const { data: authorData, error: authorError } = await supabaseAdmin
    .from('authors')
    .select('*')
    .eq('id', id)
    .single();
  
  if (authorError || !authorData) {
    error = 'ì‘ê°€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
  } else {
    author = authorData;
    
    const { data: worksData } = await supabaseAdmin
      .from('works')
      .select('id, title, genre, synopsis, status, chapters_count')
      .eq('author_id', id)
      .in('status', ['ongoing', 'completed'])
      .order('updated_at', { ascending: false });
    
    works = worksData || [];
  }
} else {
  error = 'ì„œë²„ ì„¤ì • ì˜¤ë¥˜';
}
---

<Base title={author?.name || 'ì‘ê°€'}>
  {error ? (
    <div class="error">
      <h1>ğŸ˜¢ {error}</h1>
      <p><a href="/authors">â† ì‘ê°€ ëª©ë¡ìœ¼ë¡œ</a></p>
    </div>
  ) : (
    <article>
      <header class="profile">
        <div class="avatar">ğŸ“š</div>
        <div class="info">
          <h1>{author.name}</h1>
          <p class="bio">{author.bio || 'ì†Œê°œê°€ ì—†ìŠµë‹ˆë‹¤.'}</p>
          <div class="stats">
            <span>ğŸ“š {works.length}í¸</span>
          </div>
        </div>
      </header>
      
      <section class="works">
        <h2>ì—°ì¬ ì‘í’ˆ</h2>
        {works.length === 0 ? (
          <p class="empty">ì•„ì§ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
        ) : (
          <div class="work-list">
            {works.map(work => (
              <a href={`/stories/${work.id}`} class="card work-item">
                <h3>{work.title}</h3>
                <p class="meta">
                  {GENRES[work.genre] || work.genre} Â· {work.chapters_count || 0}í™”
                  <span class:list={['status', work.status]}>
                    {work.status === 'ongoing' ? 'ì—°ì¬ì¤‘' : 'ì™„ê²°'}
                  </span>
                </p>
              </a>
            ))}
          </div>
        )}
      </section>
    </article>
  )}
</Base>

<style>
  .error {
    text-align: center;
    padding: 4rem;
  }
  
  .profile {
    display: flex;
    gap: 1.5rem;
    align-items: flex-start;
    padding: 2rem;
    background: white;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin-bottom: 2rem;
  }
  
  .avatar {
    font-size: 4rem;
    width: 100px;
    height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg);
    border-radius: 50%;
  }
  
  .info h1 {
    margin-bottom: 0.5rem;
  }
  
  .bio {
    color: var(--muted);
    margin-bottom: 1rem;
  }
  
  .stats {
    color: var(--muted);
    font-size: 0.9rem;
  }
  
  .works h2 {
    margin-bottom: 1rem;
    font-size: 1.1rem;
    color: var(--muted);
  }
  
  .work-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  
  .work-item h3 {
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
  }
  
  .meta {
    font-size: 0.9rem;
    color: var(--muted);
  }
  
  .status {
    margin-left: 0.5rem;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
  }
  
  .status.ongoing {
    background: var(--accent);
    color: white;
  }
  
  .status.completed {
    background: #10b981;
    color: white;
  }
  
  .empty {
    color: var(--muted);
    text-align: center;
    padding: 2rem;
  }
</style>
