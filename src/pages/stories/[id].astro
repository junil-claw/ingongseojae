---
import Base from '../../layouts/Base.astro';
import { supabaseAdmin, GENRES } from '../../lib/supabase';

const { id } = Astro.params;

let work: any = null;
let chapters: any[] = [];
let error: string | null = null;

if (!id) {
  error = 'ì‘í’ˆ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.';
} else if (supabaseAdmin) {
  const { data: workData, error: workError } = await supabaseAdmin
    .from('works')
    .select('*, authors(id, name, bio)')
    .eq('id', id)
    .single();
  
  if (workError || !workData) {
    error = 'ì‘í’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
  } else {
    work = workData;
    
    const { data: chaptersData } = await supabaseAdmin
      .from('chapters')
      .select('id, title, chapter_number, word_count, published_at')
      .eq('work_id', id)
      .eq('status', 'published')
      .order('chapter_number', { ascending: true });
    
    chapters = chaptersData || [];
  }
} else {
  error = 'ì„œë²„ ì„¤ì • ì˜¤ë¥˜';
}
---

<Base title={work?.title || 'ì‘í’ˆ'}>
  {error ? (
    <div class="error">
      <h1>ğŸ˜¢ {error}</h1>
      <p><a href="/stories">â† ì‘í’ˆ ëª©ë¡ìœ¼ë¡œ</a></p>
    </div>
  ) : (
    <article>
      <header class="work-header">
        <h1>{work.title}</h1>
        <p class="meta">
          <a href={`/authors/${work.authors?.id}`}>{work.authors?.name || 'ìµëª…'}</a>
          Â· {GENRES[work.genre] || work.genre}
          Â· <span class:list={['status', work.status]}>
            {work.status === 'ongoing' ? 'ì—°ì¬ì¤‘' : 'ì™„ê²°'}
          </span>
        </p>
      </header>
      
      <section class="synopsis">
        <h2>ì‹œë†‰ì‹œìŠ¤</h2>
        <p>{work.synopsis}</p>
      </section>
      
      <section class="chapters">
        <h2>ëª©ì°¨ ({chapters.length}í™”)</h2>
        {chapters.length === 0 ? (
          <p class="empty">ì•„ì§ ì±•í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        ) : (
          <ul class="chapter-list">
            {chapters.map(ch => (
              <li>
                <a href={`/stories/read/${ch.id}`}>
                  <span class="ch-num">{ch.chapter_number}í™”</span>
                  <span class="ch-title">{ch.title}</span>
                  <span class="ch-words">{ch.word_count?.toLocaleString() || 0}ì</span>
                </a>
              </li>
            ))}
          </ul>
        )}
      </section>
      
      {chapters.length > 0 && (
        <div class="actions">
          <a href={`/stories/read/${chapters[0].id}`} class="btn btn-primary">
            ì²« í™” ì½ê¸°
          </a>
        </div>
      )}
    </article>
  )}
</Base>

<style>
  .error {
    text-align: center;
    padding: 4rem;
  }
  
  .work-header {
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border);
  }
  
  .work-header h1 {
    margin-bottom: 0.5rem;
  }
  
  .meta {
    color: var(--muted);
  }
  
  .meta a {
    color: var(--accent);
  }
  
  .status {
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
  }
  
  .status.ongoing {
    background: var(--accent);
    color: white;
  }
  
  .status.completed {
    background: #10b981;
    color: white;
  }
  
  section {
    margin: 2rem 0;
  }
  
  section h2 {
    margin-bottom: 1rem;
    font-size: 1.1rem;
    color: var(--muted);
  }
  
  .synopsis p {
    line-height: 1.8;
  }
  
  .chapter-list {
    list-style: none;
  }
  
  .chapter-list li {
    border-bottom: 1px solid var(--border);
  }
  
  .chapter-list a {
    display: flex;
    padding: 1rem 0;
    gap: 1rem;
    align-items: center;
  }
  
  .chapter-list a:hover {
    background: #f5f5f5;
  }
  
  .ch-num {
    color: var(--muted);
    min-width: 50px;
  }
  
  .ch-title {
    flex: 1;
  }
  
  .ch-words {
    color: var(--muted);
    font-size: 0.9rem;
  }
  
  .actions {
    text-align: center;
    margin-top: 2rem;
  }
  
  .empty {
    color: var(--muted);
    text-align: center;
    padding: 2rem;
  }
</style>
