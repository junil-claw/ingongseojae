---
import Base from '../../../layouts/Base.astro';
import { supabaseAdmin } from '../../../lib/supabase';

const { id } = Astro.params;

let chapter: any = null;
let work: any = null;
let prevChapter: any = null;
let nextChapter: any = null;
let error: string | null = null;

if (!id) {
  error = 'ì±•í„° IDê°€ í•„ìš”í•©ë‹ˆë‹¤.';
} else if (supabaseAdmin) {
  const { data: chapterData, error: chapterError } = await supabaseAdmin
    .from('chapters')
    .select('*, works(id, title, authors(name))')
    .eq('id', id)
    .single();
  
  if (chapterError || !chapterData) {
    error = 'ì±•í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
  } else {
    chapter = chapterData;
    work = chapterData.works;
    
    // ì´ì „/ë‹¤ìŒ ì±•í„°
    const { data: siblings } = await supabaseAdmin
      .from('chapters')
      .select('id, chapter_number')
      .eq('work_id', work.id)
      .eq('status', 'published')
      .order('chapter_number');
    
    if (siblings) {
      const idx = siblings.findIndex(s => s.id === id);
      if (idx > 0) prevChapter = siblings[idx - 1];
      if (idx < siblings.length - 1) nextChapter = siblings[idx + 1];
    }
  }
} else {
  error = 'ì„œë²„ ì„¤ì • ì˜¤ë¥˜';
}
---

<Base title={chapter ? `${chapter.title} - ${work?.title}` : 'ì½ê¸°'}>
  {error ? (
    <div class="error">
      <h1>ğŸ˜¢ {error}</h1>
      <p><a href="/stories">â† ì‘í’ˆ ëª©ë¡ìœ¼ë¡œ</a></p>
    </div>
  ) : (
    <article class="reader">
      <header>
        <a href={`/stories/${work.id}`} class="back">â† {work.title}</a>
        <h1>{chapter.chapter_number}í™”: {chapter.title}</h1>
        <p class="meta">{work.authors?.name} Â· {chapter.word_count?.toLocaleString() || 0}ì</p>
      </header>
      
      <div class="content" set:html={chapter.content.replace(/\n/g, '<br><br>')} />
      
      <nav class="chapter-nav">
        {prevChapter ? (
          <a href={`/stories/read/${prevChapter.id}`} class="btn">â† ì´ì „í™”</a>
        ) : <span />}
        <a href={`/stories/${work.id}`} class="btn">ëª©ë¡</a>
        {nextChapter ? (
          <a href={`/stories/read/${nextChapter.id}`} class="btn btn-primary">ë‹¤ìŒí™” â†’</a>
        ) : <span />}
      </nav>
    </article>
  )}
</Base>

<style>
  .error {
    text-align: center;
    padding: 4rem;
  }
  
  .reader {
    max-width: 700px;
    margin: 0 auto;
  }
  
  header {
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border);
  }
  
  .back {
    color: var(--accent);
    font-size: 0.9rem;
  }
  
  header h1 {
    margin: 0.5rem 0;
  }
  
  .meta {
    color: var(--muted);
  }
  
  .content {
    line-height: 2;
    font-size: 1.1rem;
    margin: 2rem 0;
  }
  
  .chapter-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 2rem 0;
    border-top: 1px solid var(--border);
    margin-top: 2rem;
  }
</style>
